---
title: Ansible Notes
---

```{=html}
<div class="py-1 w-100 d-flex">
  <img style="max-height: 256px;"  class="mx-auto" src="https://github.com/ansible/logos/blob/main/community-marks/Ansible-Community-Mark-Mango.png?raw=true"/>
</div>
```

::: { .callout-note }

Thank you to [Jeff Pullen](https://github.com/jeffcpullen) for the guidence and recommendations!

:::

# Resources and Reading

- [Ansible for Devops](https://www.ansiblefordevops.com/)
- [How to Configure Ansible Lint](https://docs.ansible.com/projects/lint/configuring/)^
- [Good practices](https://redhat-cop.github.io/automation-good-practices/) - More opinionated than 'good practices'.
- [Best practices](https://docs.ansible.com/ansible/2.8/user_guide/playbooks_best_practices.html) - Less opinionated than 'good practices'.
- [Molecule ](https://ansible.readthedocs.io/projects/molecule) - A Testing Framework for Ansible.
- [Content Organization](https://docs.ansible.com/ansible/2.8/user_guide/playbooks_best_practices.html#content-organization) - How to properly structure an ansible repository.
- [Red hat System Roles](https://access.redhat.com/articles/3050101) - Roles for automating tasks on `RHEL` machines.
- [FreeIPA](https://github.com/freeipa/ansible-freeipa) - Redhat offers a version called IdM.
- [About Ansible Creator](https://ansible.readthedocs.io/projects/creator/installing/#cli-usage)

# Recommended VSCode Setup

## Windows Specific Steps

0. [Install python](https://www.python.org/downloads/).
   Verify the `python` installation by running `python --version`.
   Verify that `python` has `pip` installed by running `pip --version`.

## General Steps

0. Install VSCode for [Linux](https://code.visualstudio.com/docs/setup/linux) or
   [Windows](https://code.visualstudio.com/docs/setup/windows).
1. Run `pip install ansible ansible-creator ansible-lint ansible-dev-tools`.
2. Add the redhat `yaml` and `ansible` extensions (check that the publisher is
   ansible).

# Starting a New Project in VSCode

## Determine Which Kind of Project Is to be Made

To make reusable components for others to use contribute to an existing collection
or create it yourself.

Generally roles should not be kept in the same repo as the playbooks and inventories,
they should be their own repos for sake of reusability.

1. Look for the ansible icon on the left hand side of VSCode and click it.

# Deeper LSP Feedback

I am generally unaware of the ansible development experience inside of VSCode
and other tools as my editor of choice is `neovim` since I love the terminal
driven workflow.

Currently I use [`ansiblels`](https://github.com/ansible/vscode-ansible) which
I understand to be the same tooling that VSCode uses in addition to the
[`yaml-language-server`](https://github.com/redhat-developer/yaml-language-server)
which I have configured to point use various JSON schemas which can be found
inside of the [ansible lint github repository](https://github.com/ansible/ansible-lint/blob/main/src/ansiblelint/schemas/ansible-navigator.json).
`ansiblels` integrates with [`ansible-lint`](https://docs.ansible.com/projects/lint/configuring/)
which can be configured quite extensively.

With `yaml-language-server` the filenames to match can be provided explicitly
as in @fig-yaml-modeline.

::: {#fig-yaml-modeline}

```yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/execution-environment.json#/$defs/v3
version: 3
dependencies:
  galaxy: requirements.yml
  python: pyproject.toml
  python_interpreter:
    # NOTE(acederberg): Specific to `fedora:43`.
    python_path: /bin/python3.14
  ansible_core:
    package_pip: ansible-core
  ansible_runner:
    package_pip: ansible-runner
  system:
    - openssh-clients
images:
  base_image:
    name: registry.fedoraproject.org/fedora:43
options:
  user: ansible
  tags:
    - registry.acederberg.io/devimg/execution-environment:0.1.0
  workdir: /opt/devimg
```

Use of a modeline to tell `yaml-language-server` which schema to validate the
yaml content againsts. Notice the fragment at the end of the URL - this tells
`yaml-language-server` which schema in the schema bundle to use.

:::

Essentially I would advocate for the use of these json schemas with whatever
`yaml` linting tool you've got to get great things like suggestions, structure
validation, and more. I stumbled upon this with `docker compose` where my
compose configuration files would have to be run to recieve feedback and I
would frequently visit the `docker compose` documentation to recall the exact
names of some particular field - this was less than desirable.

# Repoducability

It is extremely helpful for yourself and others to use containers to develop and
execute ansible, especially in air-gapped environments where it will be necessary
to pull some dependencies down from something like `nexus` or `artifcatory` if
this were not done.

This can also help contributors avoid having to setup some pain in the ass software
and clutter up their machine just to contribute and run a project.
Containers allow filesystems containing all of these installed dependencies to
be shipped in a relatively lightweight fasion such that the host OS can overlay
these filesystems and run whatever software it contains.

In a certain usecase of mine I am using `ansible` to setup
`nexus` on an airgapped system using `podman` - this means I have nowhere to
pull my dependencies from and will likely encounter version problems even if
I were to download the wheels for all of my dependencies.

[Execution environments](https://docs.ansible.com/projects/ansible/latest/getting_started_ee/build_execution_environment.html)
are the solution to this conundrum - this allows a user to provide a simple
yaml configuration as in @fig-yaml-modeline to generate a `Containerfile` or
`Dockerfile` in the case of `podman` and `docker` respecively.

## Building the Container Image

To create the execution environment, first write out an `execution-environment.yaml`
in the project root directory and then run the script in @fig-builder

::: { #fig-builder }

```sh
ansible-builder build
```

Command for generating the execution environment image.

:::

The command in @fig-builder will create a folder called `context` wherein there
will be a `Containerfile` of some sort.

::: { .callout-warning .collapse collapse=true }

## Using Poetry

`pip` is generall considered to be a dumpsterfire. Accordingly, many python
users use tools like poetry. Since poetry does not use `requirements.txt`, it
is necessary to generate one. This can be dones as follows:

```sh
pip install poetry-plugin-export
poetry export > requirements.txt
```

:::

## Invoking the Container Image

The various playbooks inside of an ansible project can be invoked using the
container image that was built in the previous step.
This can be done using the `ansible-navigator` command as in @fig-navigator.

::: { #fig-navigator }

```sh
ansible-navigator run \
  --execution-environment <name-of-my-execution-environment-here> \
  --o
```

:::

```sh

```
